"use strict";(()=>{var N=document.querySelector("#cart-button"),A=document.querySelector("#added-to-cart");window.dataLayer=window.dataLayer||[];var S=async r=>{try{let t=await fetch("https://koszyk.deckline.pl/api/retrieve-payment-intent",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({paymentIntent:r})});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);let o=await t.json();return o.isValid===!1?(console.error("Error retrieving payment intent:",o.message),null):o.paymentIntentResult}catch{return null}},M=async r=>{try{let t=await fetch("https://koszyk.deckline.pl/api/fetch-order-from-baselinker",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({orderId:r})});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return await t.json()}catch(t){throw console.error("Error fetching order:",t),t}};function j(r){document.querySelectorAll(".order-item-list").forEach(o=>{if(o){let a=n=>n.toLocaleString("pl-PL",{minimumFractionDigits:2,maximumFractionDigits:2});o.innerHTML="",r.forEach(n=>{let i=document.createElement("div");i.className="w-commerce-commercecheckoutorderitem order-item",i.innerHTML=`
          <div class="w-commerce-commercecheckoutorderitemdescriptionwrapper">
            <div class="w-commerce-commerceboldtextblock">${n.name}</div>
            <div class="w-commerce-commercecheckoutorderitemquantitywrapper">
              <div>Ilo\u015B\u0107: </div>
              <div>${n.quantity}</div>
            </div>
          </div>
          <div>${a(n.price_brutto)} z\u0142</div>
        `,o.appendChild(i)})}})}var P=async()=>{try{let r=new URLSearchParams(window.location.search),t=r.get("redirect_status")??"",o=r.get("payment_intent")??"";if(t==="succeeded"&&o){let a=await S(o);if(!a){alert("Wyst\u0105pi\u0142 b\u0142\u0105d podczas pobierania informacji o zamiarze zap\u0142aty. Skontaktuj si\u0119 z nami w celu wyja\u015Bnienia sytuacji."),console.error("Error retrieving payment intent.");return}let n=a.metadata?.order_id;if(!n){alert("Nie znale\u017Ali\u015Bmy Twojego zam\xF3wienia. Skontaktuj si\u0119 z nami w celu wyja\u015Bnienia sytuacji."),console.error("Order ID not found in payment intent metadata.");return}try{let i=await M(n),c=H();if(c){let{email:s,name:l,address:d,city:m,zip:u,country:p,nip:y,phone:f,additionalInfo:q,shipmentMethod:L,parcelMachine:C,companyName:w,companyAddress:g,companyZIP:v,companyCity:k}=c,e=i?.orders?.[0];if(!e){console.error("Order not found.");return}let{products:b}=e;s&&(s.textContent=e?.email||""),l&&(l.textContent=e?.delivery_fullname||""),d&&(d.textContent=e?.delivery_address||""),m&&(m.textContent=e?.delivery_city||""),u&&(u.textContent=e?.delivery_postcode||""),p&&(p.textContent=e?.delivery_country||""),f&&(f.textContent=e?.phone||""),q&&(q.textContent=e?.user_comments||""),L&&(L.textContent=e?.delivery_method||""),C&&(C.textContent=e?.delivery_point_id||""),y&&(e?.invoice_nip?y.textContent=e.invoice_nip:y.parentElement?.remove()),w&&(e?.invoice_company?w.textContent=e.invoice_company:w.parentElement?.remove()),g&&(e?.invoice_address?g.textContent=e.invoice_address:g.parentElement?.remove()),v&&(e?.invoice_postcode?v.textContent=e.invoice_postcode:v.parentElement?.remove()),k&&(e?.invoice_city?k.textContent=e.invoice_city:k.parentElement?.remove()),j(b);let E=b.reduce((h,x)=>h+x.price_brutto*x.quantity,0),I=E*.23,T=e?.payment_done,_=Math.max(T,0),z=Math.round((T-E-e?.delivery_price)*100)/100;window.dataLayer.push({ecommerce:null}),window.dataLayer.push({event:"purchase",ecommerce:{transaction_id:n,affiliation:"Deckline Store",value:_,currency:"PLN",tax:I,shipping:e?.delivery_price||0,discount:z,items:b.map(h=>({item_id:h.product_id,item_name:h.name,affiliation:"Google Merchandise Store",price:h.price_brutto,quantity:h.quantity}))}}),$(E,I,e?.delivery_method,e?.delivery_price,_,z)}}catch(i){alert("Wyst\u0105pi\u0142 b\u0142\u0105d podczas pobierania zam\xF3wienia. Skontaktuj si\u0119 z nami."),console.error("Error fetching Baselinker order:",i)}}else if(t==="pending")alert("Twoje zam\xF3wienie jest nadal przetwarzane. Kliknij OK, aby strona od\u015Bwie\u017Cy\u0142a si\u0119 w przeci\u0105gu 10 sekund, aby sprawdzi\u0107 ponownie status."),setTimeout(async()=>{let a=await S(o);if(!a){alert("Wyst\u0105pi\u0142 b\u0142\u0105d podczas pobierania informacji o p\u0142atno\u015Bci.");return}if(a.status==="succeeded"){r.set("redirect_status","succeeded");let n=`${window.location.pathname}?${r.toString()}`;window.location.replace(n)}else if(a.status==="requires_payment_method"){alert("Nie doko\u0144czy\u0142e\u015B p\u0142atno\u015Bci. Kliknij OK, aby spr\xF3bowa\u0107 jeszcze raz.");let n=`${window.location.origin}/koszyk`;window.location.replace(n)}},1e4);else if(t==="cancelled"){alert("Anulowa\u0142e\u015B p\u0142atno\u015B\u0107. Spr\xF3buj jeszcze raz. Kliknij OK, aby nast\u0105pi\u0142o przekierowanie.");let a=`${window.location.origin}/koszyk`;window.location.replace(a)}}catch(r){alert("Wyst\u0105pi\u0142 b\u0142\u0105d. Skontaktuj si\u0119 z nami w celu wyja\u015Bnienia sytuacji."),console.error("Error retrieving order details:",r)}},H=()=>{let r=document.querySelector("#Email"),t=document.querySelector("#wf-ecom-shipping-name"),o=document.querySelector("#wf-ecom-shipping-address"),a=document.querySelector("#wf-ecom-shipping-city"),n=document.querySelector("#wf-ecom-shipping-zip"),i=document.querySelector("#wf-ecom-shipping-country"),c=document.querySelector("#nip"),s=document.querySelector("#Telefon"),l=document.querySelector("#DodatkoweInformacje"),d=document.querySelector("#shipment-field"),m=document.querySelector("#parcel-field"),u=document.querySelector("#nazwa-firmy"),p=document.querySelector("#Ulica"),y=document.querySelector("#Kod-pocztowy"),f=document.querySelector("#Miasto");return{email:r,name:t,address:o,city:a,zip:n,country:i,nip:c,phone:s,additionalInfo:l,shipmentMethod:d,parcelMachine:m,companyName:u,companyAddress:p,companyZIP:y,companyCity:f}},$=(r,t,o,a,n,i)=>{let c=y=>y.toLocaleString("pl-PL",{minimumFractionDigits:2,maximumFractionDigits:2}),s=document.querySelector(".products-cost");s&&(s.textContent=`${c(r)} z\u0142`);let l=document.querySelector(".tax");l&&(l.textContent=`${c(t)} z\u0142`);let d=document.querySelector(".shipment-method-choice");d&&(d.textContent=`${o}`);let m=document.querySelector(".shipment-method-value");m&&(m.textContent=`${c(a)} z\u0142`);let u=document.querySelector(".coupon-amount");u&&(u.textContent=`${c(i)} z\u0142`);let p=document.querySelector(".total-cost");p&&(p.textContent=`${c(n)} z\u0142`)};document.addEventListener("DOMContentLoaded",async()=>{await P()});})();
